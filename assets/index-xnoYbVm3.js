import{u as A,r as i,c as x,o as _,a as n,b as c,t as h,_ as P,d as W,e as z,w as f,f as F,g as I,h as K,i as k,L as M}from"./index-CnJdDVBr.js";import{u as B,I as N,C as j,F as q,B as E,a as L,s as y,g as O,b as V,W as v,c as D,d as R,e as G}from"./index-ClQKARMb.js";const H={class:"flex flex-col items-center min-h-[100vh] p-[20px] bg-[#f1f5f9]"},J={class:"w-full p-[20px] pt-[50px] rounded-lg text-center bg-white"},Q={class:"flex justify-center mb-[16px]"},X={class:"flex justify-center items-center w-[60px] h-[60px] rounded-full bg-[#07c160]"},Y={class:"p-[16px] mb-[20px] rounded-lg text-left bg-[#f8f8f8]"},Z={class:"flex py-[8px]"},ee={class:"flex-1 text-[#333] break-all"},te={class:"flex items-center py-[8px]"},ne={class:"flex-1 text-[#333]"},oe={__name:"result",setup(C){const d=A(),l=B(),p=i(l.userInfo.openid),o=i(l.userInfo.phone),r=()=>{d.push("/wechatUnBind")};return(u,s)=>{const m=N;return _(),x("div",H,[n("div",J,[n("div",Q,[n("div",X,[c(m,{name:"success",color:"#fff",size:"36"})])]),s[2]||(s[2]=n("div",{class:"mb-[20px] text-[16px] text-[#333]"},"您已完成手机号绑定，信息如下",-1)),n("div",Y,[n("div",Z,[s[0]||(s[0]=n("span",{class:"w-[60px] text-[#666]"},"openid:",-1)),n("span",ee,h(p.value),1)]),n("div",te,[s[1]||(s[1]=n("span",{class:"w-[60px] text-[#666]"},"手机号:",-1)),n("span",ne,h(o.value),1),n("span",{class:"px-[10px] py-[4px] text-[#1989fa]",onClick:r},"解绑")])])])])}}},se={class:"flex flex-col min-h-[100vh] p-[16px] bg-[#f1f5f9]"},ae={class:"p-[16px] rounded-lg bg-[#fff]"},le={class:"flex"},ie={class:"flex-1 text-[#333] break-all"},re={class:"my-[16px]"},ce={__name:"form",emits:["onBind"],setup(C,{emit:d}){const l=B(),p=d,o=i(""),r=i(""),u=i(60),s=i(!1),m=W(()=>s.value?`${u.value}秒后重试`:"获取验证码"),g=e=>e?/^1[3-9]\d{9}$/.test(o.value)?!0:"请输入正确的手机号码":"请输入手机号码",b=()=>{if(!o.value){y("请输入手机号");return}if(!/^1[3-9]\d{9}$/.test(o.value)){y("请输入正确的手机号码");return}O({phone:o.value,terminal:l.userInfo.openid,terminalType:3,appKey:v}).then(e=>{if(e.code=="0"){V("验证码已发送"),s.value=!0,u.value=60;const t=setInterval(()=>{u.value--,u.value<=0&&(clearInterval(t),s.value=!1)},1e3)}})},a=()=>{D([{code:o.value,verificationCode:r.value,syncTerminalList:[{terminal:o.value,terminalType:1},{terminal:l.userInfo.openid,terminalType:3,appKey:v}]}]).then(e=>{e.code==="0"&&(V("账号绑定成功"),l.setUserInfo({...l.userInfo,phone:o.value}),p("onBind",{phone:o.value}))})};return(e,t)=>{const T=q,U=E,$=j,S=L;return _(),x("div",se,[n("div",null,[n("div",ae,[n("div",le,[t[2]||(t[2]=n("span",{class:"w-[60px] text-[#333]"},"openid:",-1)),n("span",ie,h(z(l).userInfo.openid),1)])]),c(S,{class:"mt-[20px]",onSubmit:a},{default:f(()=>[c($,{inset:""},{default:f(()=>[c(T,{modelValue:o.value,"onUpdate:modelValue":t[0]||(t[0]=w=>o.value=w),label:"手机号",type:"tel",placeholder:"请输入手机号",rules:[{validator:g}]},null,8,["modelValue","rules"]),c(T,{modelValue:r.value,"onUpdate:modelValue":t[1]||(t[1]=w=>r.value=w),center:"",label:"验证码",type:"digit",placeholder:"请输入验证码",rules:[{required:!0,message:"请填写验证码"}]},{button:f(()=>[c(U,{size:"small",type:"primary",class:"w-[86px]",disabled:s.value,onClick:F(b,["prevent"])},{default:f(()=>[I(h(m.value),1)]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),n("div",re,[c(U,{round:"",block:"",type:"primary","native-type":"submit"},{default:f(()=>t[3]||(t[3]=[I("提 交")])),_:1})])]),_:1})])])}}},de=P(ce,[["__scopeId","data-v-7a314b52"]]),pe={key:0,class:"flex flex-col justify-center items-center h-[100vh] bg-[#f1f5f9]"},_e={__name:"index",setup(C){const d=B(),l=i(!0),p=i(!1),o=i(""),r=i("");K(()=>{u()});const u=()=>{const a=window.location.href;let e=s();e==null||e===""?window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+v+"&redirect_uri="+encodeURIComponent(a)+"&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect":m(e)},s=()=>{const e=window.location.href.match(/code=([^&]+)/);return e?e[1]:null},m=a=>{R({code:a,appKey:v}).then(e=>{if(!(e!=null&&e.openid))return y({message:(e==null?void 0:e.errmsg)||"获取openid失败",duration:3e3});o.value=e.openid,d.setUserInfo({...d.userInfo,openid:e.openid}),g()})},g=async()=>{try{G({terminal:o.value,terminalType:3,appKey:v}).then(a=>{const{code:e,data:t}=a;e==="0"&&(d.setUserInfo({openid:t.terminal,phone:t.phone}),p.value=t.terminal&&t.phone,o.value=t.terminal,t.phone&&(r.value=t.phone))})}catch{y("获取用户信息失败")}finally{l.value=!1}},b=a=>{p.value=!0,r.value=a.phone};return(a,e)=>{const t=M;return _(),x("div",null,[l.value?(_(),x("div",pe,[c(t,{size:"24px",color:"#1989fa"},{default:f(()=>e[0]||(e[0]=[I("加载中...")])),_:1}),e[1]||(e[1]=n("div",{class:"mt-[8px] text-[14px] text-[#969799]"},"正在获取用户信息",-1))])):p.value?(_(),k(oe,{key:1})):(_(),k(de,{key:2,onOnBind:b}))])}}};export{_e as default};
